% written by Dohyun Kim
% Public Domain

\NeedsTeXFormat{LaTeX2e}[2021/06/01]
\ProvidesPackage{colorjamo}[2026/01/02 v0.5 Color Old Hangul Jamo]

\RequirePackage{luacolor}
\ExplSyntaxOn
\cs_if_exist:NTF \pdfmanagement_if_active:TF
{
  \pdfmanagement_if_active:TF { } { \RequirePackage{transparent} }
}
{
  \RequirePackage{transparent}
}
\ExplSyntaxOff

\newattribute\colorchoattr
\newattribute\colorjungattr
\newattribute\colorjongattr
\newattribute\opacityjamoattr

\directlua{ require "colorjamo" }

\ifdefined\TRP@colorstack % transparent package
  \let\colorjamo@transparent@use\transparent@use
  \def\colorjamo@transparent#1{%
    \ifx\transparent@use\colorjamo@transparent@use
      \transparent@use{#1}%
      \colorjamo@setopacity{#1}%
    \else
      \if@filesw
        \immediate\write\@auxout{\string\transparent@use{#1}}%
      \fi
      \def\transparent@current{#1}%
      \@ifundefined{TRP\transparent@current}%
                   {\global\TRP@reruntrue}%
                   {\colorjamo@setopacity{#1}}%
    \fi
  }
\else % l3pdfmanagement
  \ExplSyntaxOn
  \cs_new_nopar:Npn \colorjamo@transparent #1
  {
    \pdfmanagement_add:nnn { Page/Resources/ExtGState }
                           { TRP #1 }
                           { << /ca ~ #1 /CA ~ #1 >> }
    \colorjamo@setopacity { #1 }
  }
  \ExplSyntaxOff
\fi

% colorjamo environment
\newif\if@in@colorjamo
\chardef\jamoopacityid\z@
\protected\def\colorjamo{%
  \@in@colorjamotrue
  \colorchoattr   \colorchoid
  \colorjungattr  \colorjungid
  \colorjongattr  \colorjongid
  \ifnum\jamoopacityid>\z@
    \opacityjamoattr\jamoopacityid
  \fi
}

% set colors
\protected\def\jamocolorcho #1{%
  \chardef\colorchoid\getluacolorid{#1}\relax
  \if@in@colorjamo
    \colorchoattr\colorchoid
  \fi
}
\protected\def\jamocolorjung#1{%
  \chardef\colorjungid\getluacolorid{#1}\relax
  \if@in@colorjamo
    \colorjungattr\colorjungid
  \fi
}
\protected\def\jamocolorjong#1{%
  \chardef\colorjongid\getluacolorid{#1}\relax
  \if@in@colorjamo
    \colorjongattr\colorjongid
  \fi
}
% set opacity
\protected\def\jamotransparency#1{%
  \edef\@tempa{\getjamotransparency{#1}}%
  \def\@tempb{1}%
  \ifx\@tempa\@tempb
    \chardef\jamoopacityid\z@
  \else
    \expandafter\colorjamo@transparent\expandafter{\@tempa}%
  \fi
}
\let\jamoopacity\jamotransparency
\def\colorjamo@setopacity#1{%
  \chardef\jamoopacityid\getopacityid{#1}\relax
  \if@in@colorjamo
    \opacityjamoattr\jamoopacityid
  \fi
}

% reset on normalfont esp. output routine
\AddToHook{normalfont}{%
  \unsetattribute\colorchoattr
  \unsetattribute\colorjungattr
  \unsetattribute\colorjongattr
  \unsetattribute\opacityjamoattr
}

% default values
\jamocolorcho {FF0000} % red
\jamocolorjung{00FF00} % green
\jamocolorjong{0000FF} % blue
\jamotransparency {BB} % FF: full opacity, 00: full transparency

\endinput
